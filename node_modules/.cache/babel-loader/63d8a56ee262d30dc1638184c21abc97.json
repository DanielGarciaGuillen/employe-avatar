{"ast":null,"code":"//////////////////////////////////////////\n// Defines mappings between content-type\n// and the appropriate parsers.\n//////////////////////////////////////////\nvar Transform = require('stream').Transform;\n\nfunction parserFactory(fn) {\n  return function () {\n    var chunks = [],\n        stream = new Transform({\n      objectMode: true\n    }); // Buffer all our data\n\n    stream._transform = function (chunk, encoding, done) {\n      chunks.push(chunk);\n      done();\n    }; // And call the parser when all is there.\n\n\n    stream._flush = function (done) {\n      var self = this,\n          data = Buffer.concat(chunks);\n\n      try {\n        fn(data, function (err, result) {\n          if (err) throw err;\n          self.push(result);\n        });\n      } catch (err) {\n        // console.error('Error while processing: ', err);\n        self.push(data); // just pass the original data\n      } finally {\n        done();\n      }\n    };\n\n    return stream;\n  };\n}\n\nmodule.exports['application/json'] = parserFactory(function (buffer, callback) {\n  var err, data;\n\n  try {\n    data = JSON.parse(buffer);\n  } catch (e) {\n    err = e;\n  }\n\n  callback(err, data);\n});\nmodule.exports['text/javascript'] = module.exports['application/json'];\n\ntry {\n  var xml2js = require('xml2js'); // xml2js.Parser.parseString() has the exact same function signature\n  // as our ParseStream expects, so we can reuse this.\n\n\n  module.exports['application/xml'] = parserFactory(new xml2js.Parser({\n    explicitRoot: true,\n    explicitArray: false\n  }).parseString, true); // aliases for other XML content types\n\n  module.exports['text/xml'] = module.exports['application/xml'];\n  module.exports['application/rss+xml'] = module.exports['application/xml'];\n  module.exports['application/atom+xml'] = module.exports['application/xml'];\n} catch (e) {\n  /* xml2js not found */\n}","map":null,"metadata":{},"sourceType":"script"}